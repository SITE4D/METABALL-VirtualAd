# METABALL Virtual Ad - タスク管理

## プロジェクト進捗

**開始日**: 2025/10/20
**目標完了日**: 2025/12/01 (6週間)
**現在のフェーズ**: Phase 1 - 映像I/Oパイプライン

---

## Phase 0: 環境構築 (1-2日)

**方針**: タイムアウトを防ぐため、各ステップを小さく分割し、一つずつ確実に進める

### Step 1: 開発環境の確認
- [ ] Visual Studio 2022のインストール確認
  - [ ] バージョン確認コマンド実行
  - [ ] C++デスクトップ開発ワークロード確認
  - [ ] CMake統合ツール確認
- [ ] CUDA Toolkitのバージョン確認
  - [ ] `nvcc --version`実行
  - [ ] 環境変数CUDA_PATH確認
- [ ] CMakeのバージョン確認
  - [ ] `cmake --version`実行（3.20+必要）
- [ ] Git確認
  - [ ] `git --version`実行

### Step 2: CMakeプロジェクトのセットアップ（最小構成）
- [ ] ディレクトリ構造の整備
  - [ ] src/core/ディレクトリ作成
  - [ ] src/gui/ディレクトリ作成
  - [ ] tests/ディレクトリ作成
  - [ ] scripts/ディレクトリ作成
- [ ] 最小限のルートCMakeLists.txt作成
  - [ ] CMake最小バージョン指定
  - [ ] プロジェクト名設定
  - [ ] C++20標準設定
  - [ ] 基本的なビルド設定
- [ ] .gitignore更新
  - [ ] build/ディレクトリ追加
  - [ ] Visual Studio関連ファイル追加

### Step 3: Hello Worldアプリケーション
- [ ] 最小限のmain.cpp作成
  - [ ] "Hello, METABALL Virtual Ad!"出力
  - [ ] 正常終了コード
- [ ] CMakeLists.txtに実行可能ファイル追加
  - [ ] add_executable設定
- [ ] ビルド確認
  - [ ] `cmake -B build`実行
  - [ ] `cmake --build build`実行
- [ ] 実行確認
  - [ ] 生成された.exeファイル実行
  - [ ] 出力確認

### Step 4: vcpkgのセットアップ
- [ ] vcpkgインストール確認
  - [ ] vcpkgディレクトリ確認
  - [ ] `vcpkg version`実行
- [ ] Visual Studio統合確認
  - [ ] `vcpkg integrate install`実行済み確認
- [ ] CMakeLists.txtにvcpkg統合
  - [ ] CMAKE_TOOLCHAIN_FILE設定追加
  - [ ] vcpkg.jsonマニフェストファイル作成（後のステップ用）

### Step 5: OpenCVの基本インストールとテスト
- [ ] OpenCVインストール（基本版のみ）
  - [ ] `vcpkg install opencv4:x64-windows`実行
  - [ ] インストール完了確認（15-30分程度）
- [ ] CMakeLists.txtにOpenCV追加
  - [ ] find_package(OpenCV REQUIRED)
  - [ ] target_link_libraries設定
- [ ] 画像読み込みテストプログラム作成
  - [ ] main.cppを更新
  - [ ] 簡単な画像読み込みコード追加
  - [ ] テスト画像準備（assets/test.jpg）
- [ ] ビルド・実行確認
  - [ ] リビルド実行
  - [ ] 画像読み込み動作確認

### Phase 0完了基準
- [ ] Hello Worldアプリケーションが正常動作
- [ ] OpenCVを使った画像読み込みが成功
- [ ] GitHubリポジトリにコミット・プッシュ完了

**注意**: CUDA版OpenCV、Qt、TensorRTなどの大規模ライブラリは、Phase 1以降で必要になった時点でインストールする

---

## Phase 1: 映像I/Oパイプライン (4-6日)

### アーキテクチャ設計
- [x] IVideoSourceインターフェース設計
- [x] IVideoOutputインターフェース設計
- [x] FramePipelineクラス設計

### ライブキャプチャ実装
- [ ] DirectShowCaptureクラス実装
  - [ ] デバイス列挙
  - [ ] キャプチャ開始・停止
  - [ ] フレーム取得
  - [ ] 60fps確認
- [ ] エラーハンドリング
- [ ] ログ出力

### ファイル再生実装
- [x] FilePlaybackSourceクラス実装
  - [x] OpenCV VideoCapture利用
  - [x] 60fpsシミュレーション
  - [x] フレーム単位シーク
  - [x] 一時停止・再開
- [x] サンプル映像での動作確認

### 映像出力実装
- [ ] HDMI出力クラス実装
- [ ] ファイル録画機能（H.264）
- [ ] パススルー表示

### GUIプロトタイプ
- [ ] Qt6 メインウィンドウ作成
- [ ] ビデオプレビューウィジェット
- [ ] モード切り替えUI（ライブ/ファイル）
- [ ] 再生コントロール（再生・停止・シーク）

### パフォーマンス測定
- [ ] フレームレート測定機能実装
- [ ] CPU/GPU使用率モニタリング
- [ ] 60fps達成確認

### 完了基準
- [ ] ライブキャプチャで60fpsパススルー動作
- [ ] ファイル再生で60fpsシミュレーション
- [ ] モード切り替えが1秒以内
- [ ] フレームドロップ率0.1%以下

---

## Phase 1.5: データ収集ツール (3-4日)

### アノテーションツールGUI
- [ ] インタラクティブ座標指定機能
  - [ ] マウスクリックでバックネット4隅指定
  - [ ] グリッド表示
  - [ ] Undo/Redo機能
  - [ ] プレビュー表示
- [ ] サンプル保存機能
  - [ ] フレーム画像保存
  - [ ] JSON形式でメタデータ保存
- [ ] バッチ処理UI

### カメラパラメータ計算
- [ ] solvePnP統合
- [ ] カメラ行列推定
- [ ] 歪み係数推定
- [ ] パラメータ検証

### データ管理
- [ ] JSON Schema定義
- [ ] データローダー実装
- [ ] データセット統計表示

### サンプル収集
- [ ] サンプル映像から100フレーム以上収集
- [ ] 様々な画角・照明条件を含む
- [ ] データ品質確認

### 完了基準
- [ ] アノテーション効率100サンプル/時間以上
- [ ] 100サンプル以上収集完了
- [ ] データ整合性100%

---

## Phase 2: カメラトラッキング (7-10日)

### 特徴点ベーストラッキング
- [ ] ORB/AKAZE特徴点検出実装
- [ ] フレーム間マッチング
- [ ] ホモグラフィ推定
- [ ] RANSAC外れ値除去

### PnPソルバー統合
- [ ] OpenCV solvePnP実装
- [ ] カメラパラメータ更新
- [ ] トラッキング継続率測定

### AI補正モデル開発（Python）
- [ ] 学習スクリプト作成
  - [ ] データローダー実装
  - [ ] ResNet-18ベースモデル定義
  - [ ] 学習ループ実装
  - [ ] 検証ループ実装
- [ ] モデル訓練
  - [ ] 100エポック訓練
  - [ ] 精度評価
  - [ ] ハイパーパラメータ調整
- [ ] ONNX変換
  - [ ] torch.onnx.export
  - [ ] ONNX検証

### C++推論統合
- [ ] ONNX Runtime統合
- [ ] TensorRT変換・最適化
- [ ] 推論パイプライン実装
- [ ] 処理時間測定（目標: 5ms以内）

### トラッキング精度検証
- [ ] サンプル映像でテスト
- [ ] 再投影誤差測定（目標: 2px以内）
- [ ] 画角変化±10度対応確認
- [ ] カメラ移動追従確認

### 完了基準
- [ ] トラッキング精度2px以内
- [ ] トラッキング継続率95%以上
- [ ] 処理時間5ms/frame以内
- [ ] AI補正モデルONNX統合完了

---

## Phase 3: AIキーヤー (8-12日)

### セグメンテーションモデル開発
- [ ] 学習データ収集
  - [ ] SAMで半自動アノテーション
  - [ ] 100フレーム以上
  - [ ] マスク品質確認
- [ ] DeepLabV3+ファインチューニング（Python）
  - [ ] 事前学習モデルロード
  - [ ] データ拡張実装
  - [ ] 学習実行
  - [ ] IoU測定（目標: >0.90）
- [ ] ONNX変換
- [ ] TensorRT最適化（INT8量子化）

### デプス推定モデル統合
- [ ] MiDaS Smallモデル選定
- [ ] ONNX変換
- [ ] TensorRT最適化
- [ ] 推論速度確認（目標: 4ms以内）

### C++推論統合
- [ ] セグメンテーション推論実装
- [ ] デプス推定推論実装
- [ ] バッチ処理最適化
- [ ] GPU-GPU直接転送

### デプスベース合成実装
- [ ] CUDAカーネル実装
  - [ ] マスク合成
  - [ ] デプス比較
  - [ ] 最終合成
- [ ] エッジリファインメント
- [ ] 時間的平滑化（フレーム間一貫性）

### 品質検証
- [ ] 視覚品質評価
- [ ] オクルージョン正確性測定
- [ ] エッジ品質確認

### 完了基準
- [ ] セグメンテーション精度IoU > 0.90
- [ ] デプス推定動作確認
- [ ] 合成が自然（目視確認）
- [ ] 処理時間8ms/frame以内

---

## Phase 4: バーチャル広告レンダリング (5-7日)

### DirectX 12レンダラー実装
- [ ] デバイス・スワップチェーン作成
- [ ] コマンドキュー・リスト作成
- [ ] ディスクリプタヒープ作成

### 透視変換シェーダー
- [ ] 頂点シェーダー実装
- [ ] ピクセルシェーダー実装
- [ ] カメラパラメータ渡し
- [ ] テクスチャサンプリング

### 広告配置エンジン
- [ ] 3D平面定義（バックネット）
- [ ] 透視変換行列計算
- [ ] テクスチャマッピング
- [ ] 位置精度検証（目標: 3px以内）

### ライティング調整
- [ ] シーン輝度解析
- [ ] 広告テクスチャ調整
- [ ] 自然さ確認

### 合成パイプライン
- [ ] DirectX + CUDA連携
- [ ] フレームバッファ管理
- [ ] 最終合成出力

### 完了基準
- [ ] 広告が正しい位置に配置
- [ ] 透視変換が正確
- [ ] ライティングが自然
- [ ] 処理時間2ms/frame以内

---

## Phase 5: 統合・最適化 (5-7日)

### 全パイプライン統合
- [ ] カメラトラッキング → キーヤー → レンダリング
- [ ] エラーハンドリング統合
- [ ] ログシステム統合

### マルチスレッド最適化
- [ ] スレッドプール実装
- [ ] キャプチャスレッド
- [ ] AI推論スレッド
- [ ] レンダリングスレッド
- [ ] スレッド同期最適化

### GPU最適化
- [ ] 非同期コマンド実行
- [ ] フレームバッファプリフェッチ
- [ ] メモリコピー削減

### 60fps達成確認
- [ ] フレームレート測定
- [ ] 95%以上のフレームが16.67ms以内
- [ ] ボトルネック特定・改善

### メモリ最適化
- [ ] メモリプロファイリング
- [ ] リーク検出・修正
- [ ] 使用量削減（目標: 8GB以下）

### 安定性テスト
- [ ] 24時間連続動作テスト
- [ ] クラッシュ0回確認
- [ ] エラーリカバリ確認

### UI完成
- [ ] 設定保存・読み込み
- [ ] プリセット機能
- [ ] ステータス表示
- [ ] エラー通知

### ドキュメント最終化
- [ ] コードコメント追加
- [ ] README更新
- [ ] ユーザーマニュアル作成

### 完了基準
- [ ] 60fps安定動作（95%以上）
- [ ] 24時間連続動作確認
- [ ] メモリ使用量8GB以下
- [ ] 全機能統合完了

---

## レビューセクション

### 現在の状態
- **Phase**: Phase 1 実装中（映像I/Oパイプライン）
- **進捗率**: 25%
- **次のマイルストーン**: Phase 1 GUI実装 / ライブキャプチャ実装

### 完了した作業（Phase 0）
- [x] プロジェクト計画策定
- [x] 技術スタック選定
- [x] ドキュメント作成
  - [x] README.md
  - [x] PROJECT_OVERVIEW.md
  - [x] REQUIREMENTS.md
  - [x] TECH_STACK.md
  - [x] WINDOWS_SETUP_GUIDE.md
- [x] **Windows環境セットアップ完了**
  - [x] Visual Studio 2022確認（Version 17.14.16）
  - [x] CMake 3.31統合確認
  - [x] vcpkgマニフェストモードセットアップ
  - [x] OpenCV 4.8.0インストール・統合成功
  - [x] ビルドシステム動作確認
- [x] **CMakeプロジェクト構築**
  - [x] ディレクトリ構造整備（src/core, src/gui, tests, scripts）
  - [x] vcpkg.jsonマニフェスト作成
  - [x] UTF-8エンコーディング対応（/utf-8フラグ）
  - [x] Hello World + OpenCVテストプログラム動作確認
- [x] **GitHubリポジトリ更新**
  - [x] コミット・プッシュ完了

### 変更内容の概要
#### 実装した機能
1. **CMakeビルドシステム**
   - C++20標準設定
   - vcpkgマニフェストモード統合
   - OpenCV 4.8.0自動検出・リンク
   - MSVC UTF-8エンコーディング対応

2. **vcpkg依存関係管理**
   - vcpkg.jsonマニフェストファイル作成
   - OpenCV 4.8.0および依存パッケージ自動インストール（約15分）
   - CMAKE_PREFIX_PATH適切な設定

3. **検証プログラム**
   - システム情報表示
   - OpenCVバージョン・ビルド情報表示
   - cv::Mat作成・描画テスト
   - 正常動作確認

#### 技術的な詳細
- **ビルド環境**: Visual Studio 2022 Community (MSVC 19.44)
- **CMake**: 3.31.6（VS統合版）
- **OpenCV**: 4.8.0（vcpkg経由）
- **依存パッケージ**: protobuf, libjpeg-turbo, libpng, tiff, libwebp, zlib等（13パッケージ）

### 課題・リスク
1. **CUDA Toolkit未インストール**: Phase 1以降で必要（GPU最適化・AI推論に必須）
2. **出力キャプチャ問題**: PowerShellでの出力キャプチャに技術的問題あり（プログラム自体は正常動作）

### 完了した作業（Phase 1 - 2025/10/20）
- [x] **映像I/Oアーキテクチャ実装**
  - [x] IVideoSourceインターフェース作成
  - [x] IVideoOutputインターフェース作成
  - [x] FramePipelineクラス実装
- [x] **FilePlaybackSource実装**
  - [x] 映像ファイル読み込み機能
  - [x] フレームレート制御（60fps対応）
  - [x] シーク機能（フレーム単位）
  - [x] 一時停止・再開機能
  - [x] ループ再生機能
- [x] **テストプログラム作成**
  - [x] FilePlaybackSource動作確認
  - [x] パフォーマンス測定機能
  - [x] サンプル映像での動作テスト成功

### 次のアクション
1. **Phase 1 継続作業**
   - Qt6インストール（GUI実装用）
   - 簡易GUIプロトタイプ実装
   - DirectShowライブキャプチャ実装
   
2. **Phase 1完了後**
   - CUDA Toolkit 12.x インストール（Phase 2以降で必要）
   - TensorRT 8.6+ セットアップ（AI推論用）

---

## メモ

- サンプル映像パス: `C:\\Users\\SITE4D\\Documents\\_Assets\\VirtualAd\\2025-10-08_13-47-52.mp4`
- 広告サンプル: `C:\\Users\\SITE4D\\Documents\\_Assets\\VirtualAd\\AD_FVILLAGE.png`
- Viz Arena仕様書: `C:\\Users\\SITE4D\\Documents\\_Assets\\VirtualAd\\VizArena.pdf`

---

**最終更新**: 2025/10/20 13:04
**Phase 0完了**: 2025/10/20 12:44
**Phase 1開始**: 2025/10/20 12:57

---

## メモ

- サンプル映像パス: `C:\Users\SITE4D\Documents\_Assets\VirtualAd\2025-10-08_13-47-52.mp4`
- 広告サンプル: `C:\Users\SITE4D\Documents\_Assets\VirtualAd\AD_FVILLAGE.png`
- Viz Arena仕様書: `C:\Users\SITE4D\Documents\_Assets\VirtualAd\VizArena.pdf`

---

**最終更新**: 2025/10/20
