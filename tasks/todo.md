# METABALL Virtual Ad - タスク管理

## プロジェクト進捗

**開始日**: 2025/10/20
**目標完了日**: 2025/12/01 (6週間)
**現在のフェーズ**: Phase 0 - 環境構築

---

## Phase 0: 環境構築 (1-2日)

### Windows開発環境セットアップ
- [ ] Visual Studio 2022インストール
  - [ ] C++デスクトップ開発ワークロード
  - [ ] CMake統合ツール
  - [ ] Git連携設定
- [ ] CUDA Toolkit 12.xインストール
  - [ ] cuDNN 8.x追加
  - [ ] 環境変数設定確認
- [ ] TensorRT 8.6+セットアップ
  - [ ] ライブラリパス設定
  - [ ] サンプル実行確認
- [ ] vcpkgセットアップ
  - [ ] リポジトリクローン
  - [ ] Visual Studio統合
- [ ] CMake 3.20+インストール確認
- [ ] Python 3.10+環境構築
  - [ ] venv作成
  - [ ] requirements.txt作成
  - [ ] PyTorch + CUDA版インストール

### C++ライブラリインストール
- [ ] OpenCV 4.8+ (vcpkg)
  - [ ] `vcpkg install opencv4[contrib,cuda]:x64-windows`
  - [ ] ビルド確認
- [ ] Qt 6.5+ (vcpkg)
  - [ ] `vcpkg install qt6:x64-windows`
- [ ] ONNX Runtime GPU (vcpkg)
  - [ ] `vcpkg install onnxruntime-gpu:x64-windows`
- [ ] FFmpeg (vcpkg)
  - [ ] `vcpkg install ffmpeg:x64-windows`

### プロジェクト構造作成
- [ ] ディレクトリ構造作成
  - [ ] src/, docs/, python/, models/, data/, assets/, scripts/
- [ ] CMakeLists.txt作成
  - [ ] ルートCMakeLists.txt
  - [ ] サブディレクトリ用CMakeLists.txt
- [ ] .gitignore作成
- [ ] Hello World的なアプリケーション作成
  - [ ] main.cpp
  - [ ] ビルド確認
  - [ ] 実行確認

### 完了基準
- [ ] すべてのツールがインストール済み
- [ ] サンプルプログラムがビルド・実行可能
- [ ] GitHubリポジトリにプッシュ完了

---

## Phase 1: 映像I/Oパイプライン (4-6日)

### アーキテクチャ設計
- [ ] IVideoSourceインターフェース設計
- [ ] IVideoOutputインターフェース設計
- [ ] FramePipelineクラス設計

### ライブキャプチャ実装
- [ ] DirectShowCaptureクラス実装
  - [ ] デバイス列挙
  - [ ] キャプチャ開始・停止
  - [ ] フレーム取得
  - [ ] 60fps確認
- [ ] エラーハンドリング
- [ ] ログ出力

### ファイル再生実装
- [ ] FilePlaybackSourceクラス実装
  - [ ] OpenCV VideoCapture利用
  - [ ] 60fpsシミュレーション
  - [ ] フレーム単位シーク
  - [ ] 一時停止・再開
- [ ] サンプル映像での動作確認

### 映像出力実装
- [ ] HDMI出力クラス実装
- [ ] ファイル録画機能（H.264）
- [ ] パススルー表示

### GUIプロトタイプ
- [ ] Qt6 メインウィンドウ作成
- [ ] ビデオプレビューウィジェット
- [ ] モード切り替えUI（ライブ/ファイル）
- [ ] 再生コントロール（再生・停止・シーク）

### パフォーマンス測定
- [ ] フレームレート測定機能実装
- [ ] CPU/GPU使用率モニタリング
- [ ] 60fps達成確認

### 完了基準
- [ ] ライブキャプチャで60fpsパススルー動作
- [ ] ファイル再生で60fpsシミュレーション
- [ ] モード切り替えが1秒以内
- [ ] フレームドロップ率0.1%以下

---

## Phase 1.5: データ収集ツール (3-4日)

### アノテーションツールGUI
- [ ] インタラクティブ座標指定機能
  - [ ] マウスクリックでバックネット4隅指定
  - [ ] グリッド表示
  - [ ] Undo/Redo機能
  - [ ] プレビュー表示
- [ ] サンプル保存機能
  - [ ] フレーム画像保存
  - [ ] JSON形式でメタデータ保存
- [ ] バッチ処理UI

### カメラパラメータ計算
- [ ] solvePnP統合
- [ ] カメラ行列推定
- [ ] 歪み係数推定
- [ ] パラメータ検証

### データ管理
- [ ] JSON Schema定義
- [ ] データローダー実装
- [ ] データセット統計表示

### サンプル収集
- [ ] サンプル映像から100フレーム以上収集
- [ ] 様々な画角・照明条件を含む
- [ ] データ品質確認

### 完了基準
- [ ] アノテーション効率100サンプル/時間以上
- [ ] 100サンプル以上収集完了
- [ ] データ整合性100%

---

## Phase 2: カメラトラッキング (7-10日)

### 特徴点ベーストラッキング
- [ ] ORB/AKAZE特徴点検出実装
- [ ] フレーム間マッチング
- [ ] ホモグラフィ推定
- [ ] RANSAC外れ値除去

### PnPソルバー統合
- [ ] OpenCV solvePnP実装
- [ ] カメラパラメータ更新
- [ ] トラッキング継続率測定

### AI補正モデル開発（Python）
- [ ] 学習スクリプト作成
  - [ ] データローダー実装
  - [ ] ResNet-18ベースモデル定義
  - [ ] 学習ループ実装
  - [ ] 検証ループ実装
- [ ] モデル訓練
  - [ ] 100エポック訓練
  - [ ] 精度評価
  - [ ] ハイパーパラメータ調整
- [ ] ONNX変換
  - [ ] torch.onnx.export
  - [ ] ONNX検証

### C++推論統合
- [ ] ONNX Runtime統合
- [ ] TensorRT変換・最適化
- [ ] 推論パイプライン実装
- [ ] 処理時間測定（目標: 5ms以内）

### トラッキング精度検証
- [ ] サンプル映像でテスト
- [ ] 再投影誤差測定（目標: 2px以内）
- [ ] 画角変化±10度対応確認
- [ ] カメラ移動追従確認

### 完了基準
- [ ] トラッキング精度2px以内
- [ ] トラッキング継続率95%以上
- [ ] 処理時間5ms/frame以内
- [ ] AI補正モデルONNX統合完了

---

## Phase 3: AIキーヤー (8-12日)

### セグメンテーションモデル開発
- [ ] 学習データ収集
  - [ ] SAMで半自動アノテーション
  - [ ] 100フレーム以上
  - [ ] マスク品質確認
- [ ] DeepLabV3+ファインチューニング（Python）
  - [ ] 事前学習モデルロード
  - [ ] データ拡張実装
  - [ ] 学習実行
  - [ ] IoU測定（目標: >0.90）
- [ ] ONNX変換
- [ ] TensorRT最適化（INT8量子化）

### デプス推定モデル統合
- [ ] MiDaS Smallモデル選定
- [ ] ONNX変換
- [ ] TensorRT最適化
- [ ] 推論速度確認（目標: 4ms以内）

### C++推論統合
- [ ] セグメンテーション推論実装
- [ ] デプス推定推論実装
- [ ] バッチ処理最適化
- [ ] GPU-GPU直接転送

### デプスベース合成実装
- [ ] CUDAカーネル実装
  - [ ] マスク合成
  - [ ] デプス比較
  - [ ] 最終合成
- [ ] エッジリファインメント
- [ ] 時間的平滑化（フレーム間一貫性）

### 品質検証
- [ ] 視覚品質評価
- [ ] オクルージョン正確性測定
- [ ] エッジ品質確認

### 完了基準
- [ ] セグメンテーション精度IoU > 0.90
- [ ] デプス推定動作確認
- [ ] 合成が自然（目視確認）
- [ ] 処理時間8ms/frame以内

---

## Phase 4: バーチャル広告レンダリング (5-7日)

### DirectX 12レンダラー実装
- [ ] デバイス・スワップチェーン作成
- [ ] コマンドキュー・リスト作成
- [ ] ディスクリプタヒープ作成

### 透視変換シェーダー
- [ ] 頂点シェーダー実装
- [ ] ピクセルシェーダー実装
- [ ] カメラパラメータ渡し
- [ ] テクスチャサンプリング

### 広告配置エンジン
- [ ] 3D平面定義（バックネット）
- [ ] 透視変換行列計算
- [ ] テクスチャマッピング
- [ ] 位置精度検証（目標: 3px以内）

### ライティング調整
- [ ] シーン輝度解析
- [ ] 広告テクスチャ調整
- [ ] 自然さ確認

### 合成パイプライン
- [ ] DirectX + CUDA連携
- [ ] フレームバッファ管理
- [ ] 最終合成出力

### 完了基準
- [ ] 広告が正しい位置に配置
- [ ] 透視変換が正確
- [ ] ライティングが自然
- [ ] 処理時間2ms/frame以内

---

## Phase 5: 統合・最適化 (5-7日)

### 全パイプライン統合
- [ ] カメラトラッキング → キーヤー → レンダリング
- [ ] エラーハンドリング統合
- [ ] ログシステム統合

### マルチスレッド最適化
- [ ] スレッドプール実装
- [ ] キャプチャスレッド
- [ ] AI推論スレッド
- [ ] レンダリングスレッド
- [ ] スレッド同期最適化

### GPU最適化
- [ ] 非同期コマンド実行
- [ ] フレームバッファプリフェッチ
- [ ] メモリコピー削減

### 60fps達成確認
- [ ] フレームレート測定
- [ ] 95%以上のフレームが16.67ms以内
- [ ] ボトルネック特定・改善

### メモリ最適化
- [ ] メモリプロファイリング
- [ ] リーク検出・修正
- [ ] 使用量削減（目標: 8GB以下）

### 安定性テスト
- [ ] 24時間連続動作テスト
- [ ] クラッシュ0回確認
- [ ] エラーリカバリ確認

### UI完成
- [ ] 設定保存・読み込み
- [ ] プリセット機能
- [ ] ステータス表示
- [ ] エラー通知

### ドキュメント最終化
- [ ] コードコメント追加
- [ ] README更新
- [ ] ユーザーマニュアル作成

### 完了基準
- [ ] 60fps安定動作（95%以上）
- [ ] 24時間連続動作確認
- [ ] メモリ使用量8GB以下
- [ ] 全機能統合完了

---

## レビューセクション

### 現在の状態
- **Phase**: Phase 0（ドキュメント作成中）
- **進捗率**: 5%
- **次のマイルストーン**: Windows環境セットアップ完了

### 完了した作業
- [x] プロジェクト計画策定
- [x] 技術スタック選定
- [x] ドキュメント作成（進行中）
  - [x] README.md
  - [x] PROJECT_OVERVIEW.md
  - [x] REQUIREMENTS.md
  - [x] TECH_STACK.md
  - [ ] ARCHITECTURE.md（次）
  - [ ] IMPLEMENTATION_PLAN.md（次）
  - [ ] AI_MODEL_STRATEGY.md（次）
  - [ ] DEVELOPMENT_GUIDE.md（次）

### 課題・リスク
なし（開始前）

### 次のアクション
1. 残りのドキュメント作成完了
2. MacからWindowsへプロジェクト移行
3. Windows環境セットアップ開始

---

## メモ

- サンプル映像パス: `/Users/shojikumamoto/Documents/_Assets/VirtualAd/Fighters_2025-10-08_13-47-52.mp4`
- 広告サンプル: `/Users/shojikumamoto/Documents/_Assets/VirtualAd/AD_FVILLAGE.png`
- Viz Arena仕様書: `/Users/shojikumamoto/Documents/_Assets/VirtualAd/VizArena.pdf`

---

**最終更新**: 2025/10/20
