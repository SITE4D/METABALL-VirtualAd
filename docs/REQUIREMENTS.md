# 要件定義

## 機能要件

### 1. カメラトラッキング（AIアシストキャリブレーション）

#### FR-1.1: 自動カメラパラメータ推定
- **優先度**: 必須
- **説明**: カメラ映像のみから、カメラの内部パラメータと外部パラメータを自動推定する
- **入力**:
  - カメラ映像（1920x1080 @ 60fps）
- **出力**:
  - カメラ行列（3x3）
  - 歪み係数
  - 回転ベクトル（3要素）
  - 平行移動ベクトル（3要素）
- **成功基準**:
  - 推定精度: 2ピクセル以内の再投影誤差
  - 処理時間: 5ms/frame以内

#### FR-1.2: リアルタイムトラッキング
- **優先度**: 必須
- **説明**: フレーム間で特徴点を追跡し、カメラパラメータを更新
- **入力**: 連続するビデオフレーム
- **出力**: 各フレームのカメラパラメータ
- **成功基準**:
  - トラッキング継続率: 95%以上
  - 処理時間: 3ms/frame以内
  - 画角変化対応: ±10度

#### FR-1.3: カメラ移動対応
- **優先度**: 必須
- **説明**: カメラのパン・チルト動作に追従
- **入力**: カメラ移動を含む映像
- **出力**: 移動後のカメラパラメータ
- **成功基準**:
  - 追従遅延: 3フレーム以内
  - 位置精度: 5%以内の誤差

#### FR-1.4: AI補正
- **優先度**: 高
- **説明**: ディープラーニングモデルによるカメラパラメータ補正
- **入力**:
  - カメラ映像
  - 初期推定パラメータ
- **出力**: 補正されたカメラパラメータ
- **成功基準**:
  - 精度向上: 従来手法比で30%改善
  - 処理時間: 4ms/frame以内

### 2. AIキーヤー（デプスベースコンポジット）

#### FR-2.1: セグメンテーション
- **優先度**: 必須
- **説明**: 選手・審判を背景から分離
- **入力**: カメラ映像
- **出力**: セグメンテーションマスク（0-255）
- **成功基準**:
  - 精度: IoU > 0.90
  - 処理時間: 4ms/frame以内
  - エッジ品質: 1ピクセルの精度

#### FR-2.2: デプス推定
- **優先度**: 必須
- **説明**: シーンの深度マップを推定
- **入力**: カメラ映像
- **出力**: デプスマップ（正規化済み）
- **成功基準**:
  - 相対精度: 10%以内の誤差
  - 処理時間: 4ms/frame以内

#### FR-2.3: デプスベース合成
- **優先度**: 必須
- **説明**: デプス情報に基づき選手と広告を合成
- **入力**:
  - 元映像
  - セグメンテーションマスク
  - デプスマップ
  - バーチャル広告
- **出力**: 合成映像
- **成功基準**:
  - 視覚品質: 目視で違和感なし
  - オクルージョン正確性: 95%以上
  - 処理時間: 2ms/frame以内

### 3. 映像入出力

#### FR-3.1: ライブキャプチャ
- **優先度**: 必須
- **説明**: HDMIキャプチャデバイスからリアルタイム入力
- **入力ソース**: USB HDMI（Elgato等）
- **解像度**: 1920x1080
- **フレームレート**: 60fps
- **成功基準**:
  - フレームドロップ率: 0.1%以下
  - レイテンシー: 50ms以内

#### FR-3.2: ファイル再生
- **優先度**: 必須
- **説明**: 録画済み映像ファイルを入力
- **対応フォーマット**: MP4, MOV, AVI
- **機能**:
  - 再生・一時停止
  - フレーム単位シーク
  - 60fpsシミュレーション
- **成功基準**:
  - 再生精度: ±1フレーム
  - シーク時間: 100ms以内

#### FR-3.3: HDMI出力
- **優先度**: 必須
- **説明**: 処理済み映像をHDMI出力
- **解像度**: 1920x1080 @ 60fps
- **成功基準**:
  - 出力レイテンシー: 20ms以内
  - 同期精度: ±1フレーム

#### FR-3.4: ファイル録画
- **優先度**: 中
- **説明**: 処理結果を動画ファイルとして保存
- **出力フォーマット**: MP4 (H.264)
- **成功基準**:
  - リアルタイム録画: 60fps維持
  - ファイルサイズ: 10MB/分以下

### 4. バーチャル広告レンダリング

#### FR-4.1: 3D配置
- **優先度**: 必須
- **説明**: バックネット平面に3D広告を配置
- **入力**:
  - 広告テクスチャ
  - カメラパラメータ
  - バックネット座標
- **出力**: 透視変換された広告画像
- **成功基準**:
  - 位置精度: 3ピクセル以内
  - 処理時間: 2ms/frame以内

#### FR-4.2: ライティング調整
- **優先度**: 中
- **説明**: シーンの照明に合わせて広告の明るさを調整
- **入力**: シーンの平均輝度
- **出力**: 調整された広告テクスチャ
- **成功基準**:
  - 自然さ: 目視で違和感なし
  - 処理時間: 1ms/frame以内

#### FR-4.3: 複数広告対応
- **優先度**: 低
- **説明**: 異なる広告を複数エリアに配置
- **入力**: 複数の広告テクスチャと配置情報
- **出力**: 合成映像
- **成功基準**:
  - 同時表示数: 最大3個
  - 処理時間: 追加1ms/広告

### 5. データ収集・学習パイプライン

#### FR-5.1: アノテーションツール
- **優先度**: 必須
- **説明**: バックネット4隅を手動指定
- **機能**:
  - マウスクリックで座標指定
  - グリッド表示
  - Undo/Redo
  - プレビュー表示
- **成功基準**:
  - 操作性: 10秒/サンプル以内
  - 精度: 1ピクセル以内

#### FR-5.2: 学習データ管理
- **優先度**: 必須
- **説明**: アノテーション結果をJSON形式で保存
- **データ構造**:
  ```json
  {
    "frame_number": 123,
    "image_path": "frames/frame_00123.png",
    "backnet_corners": [...],
    "camera_params": {...}
  }
  ```
- **成功基準**:
  - 保存速度: 100ms/サンプル以内
  - データ整合性: 100%

#### FR-5.3: 自動学習スクリプト
- **優先度**: 高
- **説明**: 収集データからAIモデルを自動訓練
- **機能**:
  - データ前処理
  - モデル訓練
  - ONNX変換
  - 精度評価
- **成功基準**:
  - 学習時間: 2時間以内（100サンプル）
  - 精度: 検証データでIoU > 0.85

### 6. ユーザーインターフェース

#### FR-6.1: メインウィンドウ
- **優先度**: 必須
- **機能**:
  - ビデオプレビュー
  - モード切り替え（ライブ/ファイル）
  - 再生コントロール
  - 設定パネル
- **成功基準**:
  - 応答性: 100ms以内
  - UI更新レート: 30fps

#### FR-6.2: キャリブレーションウィンドウ
- **優先度**: 必須
- **機能**:
  - バックネット4隅指定
  - カメラパラメータ表示
  - トラッキング状態表示
- **成功基準**:
  - 操作性: 直感的
  - リアルタイム更新: 60fps

#### FR-6.3: 設定管理
- **優先度**: 高
- **機能**:
  - 設定の保存・読み込み
  - プリセット管理
  - エクスポート・インポート
- **成功基準**:
  - 保存時間: 100ms以内
  - 設定項目数: 20以上

---

## 非機能要件

### 性能要件

#### NFR-1: リアルタイム処理
- **要件**: 60fps（16.67ms/frame）を維持
- **測定方法**: フレームレート計測ツール
- **許容範囲**: 95%以上のフレームが16.67ms以内

#### NFR-2: レイテンシー
- **要件**: 入力から出力まで100ms以内
- **測定方法**: タイムスタンプ比較
- **許容範囲**: 平均100ms、最大150ms

#### NFR-3: CPU使用率
- **要件**: 30%以下
- **測定方法**: Windows Performance Monitor
- **許容範囲**: ピーク時50%以下

#### NFR-4: GPU使用率
- **要件**: 70-80%（効率的活用）
- **測定方法**: NVIDIA-SMI
- **許容範囲**: 60-90%

#### NFR-5: メモリ使用量
- **要件**: 8GB以下
- **測定方法**: Task Manager
- **許容範囲**: 最大10GB

### 品質要件

#### NFR-6: 視覚品質
- **要件**: 広告挿入が自然で違和感がない
- **測定方法**: ユーザーテスト（5段階評価）
- **許容範囲**: 平均4.0以上

#### NFR-7: 安定性
- **要件**: 24時間連続動作可能
- **測定方法**: 長時間運用テスト
- **許容範囲**: クラッシュ0回/24時間

#### NFR-8: トラッキング継続率
- **要件**: 95%以上のフレームでトラッキング成功
- **測定方法**: ログ解析
- **許容範囲**: 90%以上

### 互換性要件

#### NFR-9: OS互換性
- **対応OS**: Windows 10 (64-bit), Windows 11 (64-bit)
- **最小バージョン**: Windows 10 Build 1903以降

#### NFR-10: GPU互換性
- **必須**: NVIDIA GPU (CUDA Compute Capability 7.5以上)
- **推奨**: RTX 3060以上
- **最小**: GTX 1660 Ti

#### NFR-11: キャプチャデバイス互換性
- **対応**: USB UVC準拠デバイス
- **推奨**: Elgato HD60 S+, Blackmagic UltraStudio

### 保守性要件

#### NFR-12: ログ出力
- **要件**: 詳細なログファイル生成
- **レベル**: ERROR, WARNING, INFO, DEBUG
- **ローテーション**: 10MB/ファイル、最大10ファイル

#### NFR-13: エラーハンドリング
- **要件**: すべての例外を適切に処理
- **リカバリ**: 可能な限り処理継続
- **通知**: エラー発生時にUI表示

#### NFR-14: モジュール性
- **要件**: コンポーネント間の疎結合
- **インターフェース**: 明確なAPI定義
- **テスト容易性**: 単体テスト可能

---

## ハードウェア要件

### 最小構成
- **OS**: Windows 10 64-bit (Build 1903以降)
- **CPU**: Intel Core i5-9400 / AMD Ryzen 5 3600以上
- **GPU**: NVIDIA GTX 1660 Ti (6GB VRAM)
- **RAM**: 16GB DDR4
- **Storage**: 100GB SSD
- **キャプチャ**: USB 3.0 HDMIキャプチャ

### 推奨構成
- **OS**: Windows 11 64-bit
- **CPU**: Intel Core i7-12700 / AMD Ryzen 7 5800X以上
- **GPU**: NVIDIA RTX 4060 (8GB VRAM)
- **RAM**: 24GB DDR4/DDR5
- **Storage**: 256GB NVMe SSD
- **キャプチャ**: Elgato HD60 S+ または同等品

### 開発環境
- **追加要件**:
  - Visual Studio 2022 (10GB)
  - CUDA Toolkit 12.x (5GB)
  - Python 3.10+ (2GB)
  - 追加ストレージ: 50GB（学習データ用）

---

## 制約条件

### 技術的制約
1. Windows専用（DirectX 12, CUDA必須）
2. NVIDIA GPU必須（TensorRT最適化）
3. 単一カメラのみ対応（マルチカメラは対象外）
4. 解像度: 1920x1080固定（4K非対応）
5. インターネット接続不要（スタンドアロン動作）

### ビジネス制約
1. 開発期間: 6-8週間
2. 予算: ハードウェア費用を除く
3. ライセンス: オープンソースライブラリ使用

### 運用制約
1. 操作者: 技術者レベル（放送エンジニア想定）
2. 運用環境: スタジアム制御室
3. メンテナンス: 週次でログ確認

---

## 将来的な拡張要件

### Phase 2（優先度: 低）
- Mac対応（Metal/Core ML）
- 4K解像度対応
- マルチカメラ対応

### Phase 3（優先度: 低）
- クラウド連携（学習データ共有）
- リアルタイム広告配信API
- 他スポーツ対応（サッカー、バスケ等）

---

## 受け入れ基準

### Phase 0完了基準
- [ ] 開発環境セットアップ完了
- [ ] ビルドシステム構築完了
- [ ] Hello World的なアプリケーション動作確認

### Phase 1完了基準
- [ ] 60fpsでビデオパススルー動作
- [ ] ライブ/ファイルモード切り替え可能
- [ ] フレームレート測定機能動作

### Phase 2完了基準
- [ ] カメラトラッキング精度2px以内
- [ ] 画角変化±10度に対応
- [ ] AI補正モデル統合完了

### Phase 3完了基準
- [ ] セグメンテーション精度IoU > 0.90
- [ ] デプス推定動作確認
- [ ] デプスベース合成が自然

### Phase 4完了基準
- [ ] バーチャル広告が正しく配置
- [ ] 透視変換が正確
- [ ] ライティング調整が自然

### Phase 5完了基準
- [ ] 60fps安定動作（95%以上）
- [ ] 24時間連続動作確認
- [ ] 全機能統合完了

---

## 参考資料

- [Viz Arena仕様書](/Users/shojikumamoto/Documents/_Assets/VirtualAd/VizArena.pdf)
- [サンプル映像](/Users/shojikumamoto/Documents/_Assets/VirtualAd/Fighters_2025-10-08_13-47-52.mp4)
- [広告画像サンプル](/Users/shojikumamoto/Documents/_Assets/VirtualAd/AD_FVILLAGE.png)

詳細な実装計画は [IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md) を参照してください。
